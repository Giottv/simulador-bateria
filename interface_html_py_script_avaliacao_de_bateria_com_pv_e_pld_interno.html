<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avaliação de Bateria com PV</title>
  
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.9.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.9.1/core.js"></script>
  
  <style>
    :root { --bg:#0b0c10; --card:#12141a; --muted:#a0a4ab; --text:#e8eaed; --accent:#3fa34d; --accent2:#247ba0; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    header { padding: 16px 22px; border-bottom: 1px solid #20232a; position: sticky; top:0; background: rgba(11,12,16,0.9); backdrop-filter: blur(6px); }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.4px; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 16px 40px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { grid-column: span 12; background: var(--card); border: 1px solid #1d212a; border-radius: 16px; padding: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    @media(min-width: 900px){ .card.left{grid-column: span 5;} .card.right{grid-column: span 7;} }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select { width: 100%; background: #0e1117; color: var(--text); border: 1px solid #2a2f3a; padding: 10px 12px; border-radius: 10px; outline: none; }
    input:focus, select:focus { border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(36,123,160,0.25); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btns { display:flex; gap:10px; margin-top: 10px; }
    button { cursor: pointer; padding: 10px 14px; border: 1px solid #263042; background: linear-gradient(180deg, #1b2636 0%, #122033 100%); color: #dfe6ef; border-radius: 10px; font-weight: 600; }
    button.primary { background: linear-gradient(180deg, #2f855a 0%, #276749 100%); border-color: #205c3b; }
    table { width:100%; border-collapse: collapse; font-size: 13px; margin-top: 12px; }
    th, td { border-bottom: 1px solid #222835; padding: 8px 10px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .muted { color: var(--muted); font-size: 12px; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3344; background:#0f1420; font-size:11px; color:#c7d2e0; }
    .kpi { display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:8px; }
    .kpi .box { background:#0e1117; border:1px solid #1d2433; border-radius:12px; padding:10px; }
    .kpi .box b { display:block; font-size:18px; margin-bottom:4px; }
    .note { margin-top:8px; font-size:12px; color:#b9c0ca; }
    .hr { height:1px; background:#1d2230; margin:12px 0; border:0; }
    .footer { margin-top: 16px; color: #8b93a1; font-size: 12px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0e1117; border:1px solid #1d2433; border-radius:12px; padding:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Simulador de Bateria + PV (PLD interno)</h1>
  </header>
  <div class="wrap">
    <div class="grid">
      <section class="card left">
        <h2 style="margin:4px 0 12px">Entradas</h2>
        <div class="row">
          <div>
            <label for="tipo">Tipo de carga (perfil em pu)</label>
            <select id="tipo">
              <option value="res">Residencial</option>
              <option value="com">Comercial</option>
              <option value="ind">Industrial</option>
            </select>
          </div>
          <div>
            <label for="demanda">Demanda máxima (kW)</label>
            <input id="demanda" type="number" step="0.1" value="500" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="pv">Capacidade instalada de PV (kW)</label>
            <input id="pv" type="number" step="0.1" value="400" />
          </div>
          <div>
            <label for="bat">Tamanho da bateria (kWh)</label>
            <input id="bat" type="number" step="0.1" value="600" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="eta">Eficiência (ida e volta)</label>
            <select id="eta">
              <option value="0.90">90%</option>
              <option value="0.92">92%</option>
              <option value="0.94" selected>94%</option>
              <option value="0.96">96%</option>
            </select>
          </div>
          <div>
            <label for="tarifa">Tarifa base (R$/MWh)</label>
            <input id="tarifa" type="number" step="1" value="300" />
          </div>
        </div>
        <div class="btns">
          <button class="primary" id="btn-run">Rodar</button>
          <button id="btn-reset">Limpar</button>
        </div>
        <p class="note">Observações:
          <br>• Carregamento <b>somente</b> com excedente solar.
          <br>• A bateria aloca energia das <span class="tag">horas de menor PLD</span> para as <span class="tag">horas de maior PLD</span> (ganancioso diário) respeitando capacidade (kWh) e eficiência.
          <br>• Não há exportação à rede (descarrega no máximo até zerar a compra).
        </p>
      </section>

      <section class="card right">
        <h2 style="margin:4px 0 12px">Resultados</h2>
        <div class="kpi">
          <div class="box"><b id="kpi-custo0">—</b><span class="muted">Custo diário antes (R$)</span></div>
          <div class="box"><b id="kpi-custo1">—</b><span class="muted">Custo diário depois (R$)</span></div>
          <div class="box"><b id="kpi-economia">—</b><span class="muted">Economia (R$) / (%)</span></div>
        </div>
        <hr class="hr"/>
        <div id="tabelas"></div>
        <div class="footer">Curvas internas fixas nesta versão: <span class="tag">PLD relativo 24h</span> e <span class="tag">Irradiação 24h</span> (amostras típicas).</div>
      </section>
    </div>
  </div>

  <script type="py" worker>
    from pyscript import document, when

    # ---- Curvas internas (24h) ----
    PLD_REL = [
        0.70, 0.68, 0.65, 0.65, 0.70, 0.80, 0.95, 1.05, 1.10, 1.00, 0.90, 0.85,
        0.80, 0.78, 0.82, 0.95, 1.10, 1.25, 1.35, 1.30, 1.15, 1.00, 0.85, 0.75
    ]
    IRR_REL = [
        0.00, 0.00, 0.00, 0.00, 0.02, 0.10, 0.30, 0.55, 0.75, 0.90, 0.98, 1.00,
        0.95, 0.85, 0.65, 0.40, 0.15, 0.04, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00
    ]
    LOAD_PU = {
        "res": [0.35,0.30,0.28,0.27,0.30,0.42,0.55,0.60,0.62,0.58,0.55,0.50,0.48,0.50,0.55,0.65,0.80,0.95,1.00,0.95,0.80,0.65,0.50,0.40],
        "com": [0.10,0.08,0.08,0.08,0.10,0.35,0.70,0.90,1.00,1.00,0.95,0.90,0.85,0.80,0.80,0.85,0.90,0.75,0.50,0.30,0.15,0.12,0.10,0.10],
        "ind": [0.25,0.25,0.25,0.25,0.30,0.50,0.80,0.95,1.00,1.00,1.00,1.00,0.95,0.95,0.95,1.00,1.00,0.95,0.80,0.60,0.45,0.35,0.30,0.28]
    }

    # ---- Utilidades ----
    def fmt(x, nd=2):
        return f"{x:,.{nd}f}".replace(",", "X").replace(".", ",").replace("X", ".")

    # ---- Núcleo da simulação (passo horário) ----
    def simular(tipo: str, demanda_max_kw: float, pv_kw: float, bat_kwh: float, eta_rt: float, tarifa_base: float):
        h = list(range(24))
        load_kw = [demanda_max_kw * LOAD_PU[tipo][i] for i in h]
        pv_kw_h = [pv_kw * IRR_REL[i] for i in h]
        pld_r_mwh = [tarifa_base * PLD_REL[i] for i in h]
        preco_r_kwh = [p / 1000.0 for p in pld_r_mwh]
        compra0 = []
        excedente = []
        for i in h:
            net = load_kw[i] - pv_kw_h[i]
            if net >= 0:
                compra0.append(net)
                excedente.append(0.0)
            else:
                compra0.append(0.0)
                excedente.append(-net)
        e_cap = max(bat_kwh, 0.0)
        eta_c = eta_rt**0.5
        eta_d = eta_rt**0.5
        horas_baratas = sorted(h, key=lambda i: preco_r_kwh[i])
        horas_caras   = sorted(h, key=lambda i: preco_r_kwh[i], reverse=True)
        soc = 0.0
        carga_bat = [0.0]*24
        descarga_bat = [0.0]*24
        for i in horas_baratas:
            if e_cap <= 1e-9: break
            if excedente[i] <= 0: continue
            espaço = e_cap - soc
            if espaço <= 1e-9: continue
            put_dc = min(excedente[i], espaço/eta_c)
            carga_bat[i] = put_dc
            soc += put_dc * eta_c
        compra1 = compra0[:]
        for i in horas_caras:
            if soc <= 1e-9: break
            demanda_compra = compra1[i]
            if demanda_compra <= 0: continue
            max_entregavel = soc * eta_d
            out_ac = min(demanda_compra, max_entregavel)
            if out_ac <= 0: continue
            descarga_bat[i] = out_ac
            compra1[i] -= out_ac
            soc -= out_ac/eta_d
        custo0 = sum(compra0[i] * preco_r_kwh[i] for i in h)
        custo1 = sum(compra1[i] * preco_r_kwh[i] for i in h)
        linhas = []
        for i in h:
            linhas.append([
                i, round(LOAD_PU[tipo][i],3), round(IRR_REL[i],3), round(PLD_REL[i],2),
                round(load_kw[i],3), round(pv_kw_h[i],3), round(excedente[i],3),
                round(carga_bat[i],3), round(descarga_bat[i],3), round(compra0[i],3),
                round(compra1[i],3), round(preco_r_kwh[i],3),
            ])
        return { "linhas": linhas, "custo0": custo0, "custo1": custo1, "economia": custo0 - custo1 }

    # ---- UI binding ----
    @when("click", selector="#btn-run")
    def run():
        tipo = document.getElementById("tipo").value
        demanda = float(document.getElementById("demanda").value or 0)
        pv = float(document.getElementById("pv").value or 0)
        bat = float(document.getElementById("bat").value or 0)
        eta = float(document.getElementById("eta").value or 0.94)
        tarifa = float(document.getElementById("tarifa").value or 300.0)
        r = simular(tipo, demanda, pv, bat, eta, tarifa)
        document.getElementById("kpi-custo0").innerText = f"R$ {fmt(r['custo0'])}"
        document.getElementById("kpi-custo1").innerText = f"R$ {fmt(r['custo1'])}"
        econ = r['economia']
        perc = 0.0 if r['custo0']<=1e-9 else (econ/r['custo0']*100.0)
        document.getElementById("kpi-economia").innerText = f"R$ {fmt(econ)} / {fmt(perc)}%"
        cols = [
            "Hora", "Load_pu", "Irr_pu", "PLD_rel", "Load_kW", "PV_kW", "Excedente_kW",
            "CargaBat_kWh", "DescargaBat_kWh", "Compra0_kWh", "Compra1_kWh", "Preço_R$/kWh"
        ]
        head = "".join([f"<th>{c}</th>" for c in cols])
        rows = []
        for linha in r["linhas"]:
            tds = "".join([f"<td>{x}</td>" for x in linha])
            rows.append(f"<tr>{tds}</tr>")
        html_tab = f"<table><thead><tr>{head}</tr></thead><tbody>{''.join(rows)}</tbody></table>"
        document.getElementById("tabelas").innerHTML = html_tab

    @when("click", selector="#btn-reset")
    def reset_ui():
        document.getElementById("tabelas").innerHTML = ""
        for k in ["kpi-custo0","kpi-custo1","kpi-economia"]:
            document.getElementById(k).innerText = "—"
  </script>
</body>
</html>